Reverse Email Verification Implementation Guide
Overview
This guide implements a dual-verification system.

IMPORTANT: PLEASE VERIFY ALL CODE AND MAKE SURE THAT IT WORKS FOR THE CURRENT IMPLEMENTATION. IF THERE ARE CONFLICTS IN IMPLEMENTATION, PLEASE ASK ME. IF YOU HAVE ANY QUESTIONS/CONCERNS, PLEASE ASK ME. 

Primary method: Traditional email verification (send link to user)
Fallback method: Reverse verification (user sends email to you)

Instead of the current screen after signing up (which shows that the verification link is successfully sent), I would like to show a different screen (that does not disappear automatically). Instead it should say that a code has been sent to their student email. However, if they don't receive a code within the next few minutes, they can verify themselves by sending an email to verify@ubcupids.org with the code below in the subject (generate and show random verification code (8 chars, uppercase alphanumeric)). The email does not need any other content. 

Architecture Overview
Registration Flow:
1. User submits registration form
2. System creates user account (emailVerified = null)
3. System generates TWO tokens:
   - verificationToken (for email link - 32 bytes, hex)
   - verificationCode (for reverse flow - 8 chars, uppercase alphanumeric)
4. System sends verification email with link
5. User clicks link → verified (primary flow)
   OR
6. User sends email with code in subject → verified (fallback flow)

If user uses the email sending method and happen to get the verification link, then that link becomes invalid (can have a message that says that they are already verified). 

Instructions generated by Claude Sonnet Web version:

Part 1: Database Schema Changes
Part 2: Registration Endpoint Updates
Part 3: Frontend UI Updates
Part 4: Resend Inbound Email Setup

### Step 4A: Configure DNS for Inbound Email

**Add MX record in Porkbun:**
```
Type: MX
Host: @ (or ubcupids.org)
Value: inbound-mail.resend.com
Priority: 5
TTL: 3600
Why priority 5: Lower than Zoho's MX priority (10), so Resend catches emails to support@ubcupids.org before Zoho does.
Step 4B: Configure Resend Webhook

Log into Resend dashboard
Go to Webhooks → Create Webhook
Configure:

URL: https://ubcupids.vercel.app/api/webhooks/verify-email
Events: Select email.received
Save and copy the webhook signing secret


Add webhook secret to environment variables:

bash# .env or Vercel environment variables
RESEND_WEBHOOK_SECRET="whsec_xxxxxxxxxxxxx"

Part 5: Webhook Endpoint Implementation
Create Webhook Handler
File: app/api/webhooks/verify-email/route.ts (create new file)
typescriptimport { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { sendEmail } from '@/lib/email'; // Your email sending utility

// Optional: Verify webhook signature for security
function verifyWebhookSignature(request: NextRequest, body: string): boolean {
  const signature = request.headers.get('svix-signature');
  const timestamp = request.headers.get('svix-timestamp');
  const webhookSecret = process.env.RESEND_WEBHOOK_SECRET;
  
  if (!signature || !timestamp || !webhookSecret) return false;
  
  // Implement signature verification based on Resend's documentation
  // For MVP, you can skip this and just check if webhook secret is in body
  return true; // Simplified for now
}

export async function POST(request: NextRequest) {
  try {
    // Parse incoming email data
    const inboundEmail = await request.json();
    
    // Verify webhook (optional but recommended)
    // const isValid = verifyWebhookSignature(request, JSON.stringify(inboundEmail));
    // if (!isValid) {
    //   return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });
    // }
    
    // Extract email details
    const fromEmail = inboundEmail.from.toLowerCase(); // "katie@student.ubc.ca"
    const subject = inboundEmail.subject || ''; // "VERIFY-A7B3C9D2"
    
    // Extract verification code from subject
    // Expected format: "VERIFY-A7B3C9D2" or "Re: VERIFY-A7B3C9D2"
    const codeMatch = subject.match(/VERIFY-([A-F0-9]{8})/i);
    
    if (!codeMatch) {
      console.log('Invalid subject format:', subject);
      return NextResponse.json({ 
        error: 'Invalid subject format. Expected: VERIFY-XXXXXXXX' 
      }, { status: 400 });
    }
    
    const verificationCode = codeMatch[1].toUpperCase();
    
    // Find user with matching email and verification code
    const user = await prisma.user.findFirst({
      where: {
        email: fromEmail,
        verificationCode: verificationCode,
        emailVerified: null, // Not yet verified
      },
    });
    
    if (!user) {
      console.log('No matching user found:', { fromEmail, verificationCode });
      
      // Send helpful error email to user
      await sendEmail({
        to: fromEmail,
        subject: 'UBCupids Verification - No Match Found',
        html: `
          <p>We received your verification email, but couldn't find a matching account.</p>
          <p>Possible reasons:</p>
          <ul>
            <li>Your account is already verified</li>
            <li>The verification code doesn't match our records</li>
            <li>You used a different email to register</li>
          </ul>
          <p>Please try registering again or contact support@ubcupids.org</p>
        `,
      });
      
      return NextResponse.json({ 
        error: 'No matching user found' 
      }, { status: 404 });
    }
    
    // Verify the user
    await prisma.user.update({
      where: { id: user.id },
      data: {
        emailVerified: new Date(),
        verificationToken: null, // Clear both tokens
        verificationCode: null,
      },
    });
    
    console.log('User verified via reverse flow:', user.email);
    
    // Send confirmation email
    await sendEmail({
      to: fromEmail,
      subject: 'Welcome to UBCupids - Account Verified!',
      html: `
        <h1>Your account is verified!</h1>
        <p>Hi ${user.firstName},</p>
        <p>Your UBCupids account has been successfully verified.</p>
        <p>You can now log in at: <a href="https://ubcupids.org/login">ubcupids.org/login</a></p>
        <p>Looking forward to helping you find your match!</p>
      `,
    });
    
    return NextResponse.json({ 
      success: true,
      message: 'User verified successfully' 
    });
    
  } catch (error) {
    console.error('Verification webhook error:', error);
    return NextResponse.json({ 
      error: 'Internal server error' 
    }, { status: 500 });
  }
}

// Disable body parsing for webhook signature verification
export const config = {
  api: {
    bodyParser: false, // If using raw body for signature verification
  },
};

Part 7: Security Considerations
Prevent Abuse
Rate limiting (optional but recommended):
typescript// In webhook endpoint, before processing
const recentVerifications = await prisma.verificationLog.count({
  where: {
    email: fromEmail,
    createdAt: { gte: new Date(Date.now() - 5 * 60 * 1000) }, // Last 5 min
  },
});

if (recentVerifications >= 3) {
  return NextResponse.json({ 
    error: 'Too many verification attempts. Please wait 5 minutes.' 
  }, { status: 429 });
}
One-Time Use Enforcement
Both tokens are cleared after successful verification:
typescriptverificationToken: null,
verificationCode: null,
This prevents:

Replay attacks
Token reuse
Multiple verifications

Email Validation
Always validate sender email matches registered email:
typescriptif (fromEmail !== user.email.toLowerCase()) {
  return NextResponse.json({ error: 'Email mismatch' }, { status: 403 });
}

Summary for AI Assistant
Implement the following:

Database: Add verificationCode field to User model
Registration API: Generate and store 8-character code, return to frontend
Frontend: Show countdown timer, display fallback instructions after 30 min
Webhook: Create /api/webhooks/verify-email endpoint to process inbound emails
DNS: Add MX record for inbound-mail.resend.com with priority 5
Testing: Verify both flows work independently

Key logic:

Primary flow: User clicks link (existing)
Fallback flow: User emails code (new)
Both flows verify user and clear tokens
Webhook parses subject for VERIFY-XXXXXXXX pattern
Match user by email + code, mark as verified